#include <stdio.h>

#include "utils.h"
#include "common.h"
#include "debugger.h"

typedef enum {
    P_TARGET_PROGRAM_FILENAME,
    P_LOG_LEVEL,
    P_INPUT_METHOD,
    P_SHELLCODE_FILE
} param;

void parse_arguments(int argc, char **argv, char **params_ptr) {
    if (argc <= 1) return;

    param current_param;

    for (int i = 1; i < argc; i++) {
        if (argv[i][0] == '-') {
            switch (argv[i][1]) {
                case 't':
                    current_param = P_TARGET_PROGRAM_FILENAME;
                    break;
                case 'v':
                    current_param = P_LOG_LEVEL;
                    break;
                case 'i':
                    current_param = P_INPUT_METHOD;
                    break;
                case 's':
                    current_param = P_SHELLCODE_FILE;
                    break;
                default:
                    error_exit(E_INCORRECT_PARAM);
            }
            continue;
        }

        params_ptr[current_param] = &argv[i][0];
    }
}

int main(int argc, char **argv) {
    if (is_aslr_enabled()) {
        error_exit(E_ASLR_ENABLED);
    }
    common_init();

    char *params[20] = {0};
    parse_arguments(argc, argv, params);

    if (!params[P_TARGET_PROGRAM_FILENAME]) error_exit(E_NO_TARGET_PROGRAM_SPECIFIED);

    commonData->target_program_file_name = params[P_TARGET_PROGRAM_FILENAME];

    if (params[P_INPUT_METHOD]) {
        commonData->input_method = (InputMethod) params[P_INPUT_METHOD][0];
    } else {
        warning(W_NO_INPUT_METHOD_SPECIFIED);
    }

    if (params[P_LOG_LEVEL]) set_log_level(atoi(params[P_LOG_LEVEL]));

    if (!does_file_exist(commonData->target_program_file_name)) {
        error_exit(E_TARGET_PROGRAM_FILE_NOT_FOUND);
    }

    debugger_init();
    debugger_find_vulnerable_functions();
    find_eip_offset();
    run_exploit();

    return 0;
}
